<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NFO Ops Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Leaflet CSS -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""
    />
    <style>
        :root {
            --color-bg: #0f172a;
            --color-bg-elevated: #020617;
            --color-bg-soft: #020617;
            --color-bg-softer: #020617;
            --color-accent: #38bdf8;
            --color-accent-soft: rgba(56, 189, 248, 0.1);
            --color-border: #1f2937;
            --color-border-soft: #111827;
            --color-text: #e5e7eb;
            --color-text-soft: #9ca3af;
            --color-text-secondary: #9ca3af;
            --color-danger: #f97373;
            --color-danger-soft: rgba(248, 113, 113, 0.1);
            --color-success: #4ade80;
            --color-success-soft: rgba(74, 222, 128, 0.15);
            --color-warning: #facc15;
            --color-warning-soft: rgba(250, 204, 21, 0.15);
            --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.9);
            --radius-large: 20px;
            --radius-pill: 999px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 16px;
            min-height: 100vh;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
            background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.18), transparent 55%),
                        radial-gradient(circle at bottom right, rgba(56, 189, 248, 0.12), transparent 55%),
                        radial-gradient(circle at top right, rgba(99, 102, 241, 0.18), transparent 55%),
                        #020617;
            color: var(--color-text);
            display: flex;
            align-items: stretch;
            justify-content: center;
        }

        .app-shell {
            width: 100%;
            max-width: 1400px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .app-header {
            display: flex;
            gap: 16px;
            align-items: flex-start;
        }

        .brand-card {
            background: linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.98));
            border-radius: 24px;
            border: 1px solid rgba(148, 163, 184, 0.25);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 1;
            box-shadow:
                0 22px 50px rgba(15, 23, 42, 0.95),
                0 0 0 1px rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(14px);
            position: relative;
            overflow: hidden;
        }

        .brand-card::before {
            content: "";
            position: absolute;
            inset: 0;
            background:
                radial-gradient(circle at top left, rgba(56, 189, 248, 0.2), transparent 55%),
                radial-gradient(circle at bottom right, rgba(59, 130, 246, 0.18), transparent 55%);
            opacity: 0.8;
            pointer-events: none;
        }

        .brand-card-inner {
            position: relative;
            display: flex;
            align-items: center;
            gap: 16px;
            width: 100%;
        }

        .brand-avatar {
            width: 52px;
            height: 52px;
            border-radius: 20px;
            background: radial-gradient(circle at 30% 20%, #38bdf8, transparent 60%),
                        radial-gradient(circle at 70% 80%, #22c55e, transparent 60%);
            border: 1px solid rgba(148, 163, 184, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow:
                0 18px 40px rgba(15, 23, 42, 1),
                0 0 0 1px rgba(15, 23, 42, 0.9);
        }

        .brand-avatar-inner {
            width: 36px;
            height: 36px;
            border-radius: 14px;
            background: radial-gradient(circle at top left, #0ea5e9, #1d4ed8);
            border: 1px solid rgba(15, 23, 42, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .brand-avatar-icon {
            width: 18px;
            height: 18px;
            border-radius: 999px;
            border: 2px solid rgba(15, 23, 42, 0.85);
            box-shadow:
                0 0 0 1px rgba(15, 23, 42, 0.85),
                0 0 20px rgba(56, 189, 248, 0.8);
            background:
                radial-gradient(circle at 30% 30%, #f9fafb, #38bdf8 60%, #0ea5e9 80%);
        }

        .brand-text {
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex: 1;
        }

        .brand-title {
            font-size: 16px;
            font-weight: 600;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            color: #e5e7eb;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .brand-title-badge {
            padding: 2px 10px;
            border-radius: 999px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.13em;
            background: rgba(17, 24, 39, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.4);
            color: #9ca3af;
        }

        .brand-subtitle {
            font-size: 13px;
            color: var(--color-text-soft);
        }

        .brand-meta-row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 4px;
        }

        .brand-meta-pill {
            font-size: 11px;
            padding: 3px 10px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            color: #9ca3af;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(15, 23, 42, 0.95);
        }

        .brand-meta-dot {
            width: 6px;
            height: 6px;
            border-radius: 999px;
            background: rgba(248, 250, 252, 0.8);
            box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.9);
        }

        .brand-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 6px;
        }

        .brand-tagline {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.16em;
            color: #9ca3af;
        }

        .brand-version {
            font-size: 11px;
            color: #6b7280;
        }

        .brand-pulse {
            width: 52px;
            height: 26px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .brand-pulse-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: #22c55e;
            box-shadow:
                0 0 0 1px rgba(15, 23, 42, 0.95),
                0 0 12px rgba(34, 197, 94, 0.9);
        }

        .login-card {
            background: rgba(15, 23, 42, 0.96);
            border-radius: 24px;
            border: 1px solid rgba(148, 163, 184, 0.25);
            padding: 14px 16px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 320px;
            box-shadow:
                0 18px 45px rgba(15, 23, 42, 0.95),
                0 0 0 1px rgba(15, 23, 42, 0.9);
        }

        .login-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .login-title {
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }

        .login-mode-toggle {
            display: inline-flex;
            background: rgba(15, 23, 42, 1);
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.35);
            padding: 2px;
        }

        .login-mode-toggle button {
            font-size: 11px;
            border: none;
            background: transparent;
            color: #9ca3af;
            padding: 3px 10px;
            border-radius: 999px;
            cursor: pointer;
        }

        .login-mode-toggle button.active {
            background: linear-gradient(135deg, #38bdf8, #22c55e);
            color: #0f172a;
            font-weight: 600;
            box-shadow:
                0 0 0 1px rgba(15, 23, 42, 0.9),
                0 8px 18px rgba(15, 23, 42, 1);
        }

        .login-card-body {
            display: grid;
            grid-template-columns: 1.4fr 1fr;
            gap: 8px;
            align-items: flex-end;
        }

        .login-input-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .login-input-group label {
            font-size: 11px;
            color: var(--color-text-soft);
        }

        .login-input-group input,
        .login-input-group select {
            width: 100%;
            padding: 7px 9px;
            border-radius: 999px;
            border: 1px solid rgba(55, 65, 81, 0.9);
            background: rgba(15, 23, 42, 0.97);
            color: var(--color-text);
            font-size: 12px;
            outline: none;
            transition: border-color 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
        }

        .login-input-group input:focus,
        .login-input-group select:focus {
            border-color: rgba(56, 189, 248, 0.9);
            box-shadow:
                0 0 0 1px rgba(15, 23, 42, 0.9),
                0 0 0 1px rgba(56, 189, 248, 0.35);
            background: rgba(15, 23, 42, 1);
        }

        .login-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: var(--color-text-soft);
        }

        .login-status-pill {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 3px 9px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.45);
            background: #020617;
        }

        .login-status-dot {
            width: 7px;
            height: 7px;
            border-radius: 999px;
            background: #22c55e;
            box-shadow: 0 0 0 1px rgba(15, 23, 42, 1);
        }

        .btn {
            border-radius: 999px;
            border: none;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            padding: 7px 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            white-space: nowrap;
        }

        .btn-primary {
            background: linear-gradient(135deg, #38bdf8, #22c55e);
            color: #0f172a;
            box-shadow:
                0 10px 25px rgba(15, 23, 42, 0.95),
                0 0 0 1px rgba(15, 23, 42, 0.95);
        }

        .btn-primary:hover {
            filter: brightness(1.05);
        }

        .btn-ghost {
            background: rgba(15, 23, 42, 0.95);
            color: var(--color-text-soft);
            border: 1px solid rgba(75, 85, 99, 0.9);
        }

        .btn-ghost:hover {
            border-color: rgba(148, 163, 184, 0.9);
        }

        .app-main {
            display: grid;
            grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.6fr);
            gap: 16px;
        }

        .panel {
            background: rgba(15, 23, 42, 0.96);
            border-radius: 24px;
            border: 1px solid rgba(148, 163, 184, 0.25);
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            box-shadow:
                0 18px 45px rgba(15, 23, 42, 0.95),
                0 0 0 1px rgba(15, 23, 42, 0.9);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }

        .panel-title-group {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .panel-title {
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }

        .panel-subtitle {
            font-size: 12px;
            color: var(--color-text-soft);
        }

        .kpi-row {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 10px;
        }

        .kpi-card {
            border-radius: 18px;
            padding: 10px 12px;
            background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 1));
            border: 1px solid rgba(55, 65, 81, 0.9);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .kpi-label {
            font-size: 11px;
            color: var(--color-text-soft);
        }

        .kpi-value {
            font-size: 18px;
            font-weight: 600;
        }

        .kpi-footer {
            font-size: 11px;
            color: var(--color-text-soft);
        }

        .layout-main {
            display: grid;
            grid-template-columns: minmax(0, 1.6fr) minmax(0, 1.1fr);
            gap: 12px;
        }

        .map-wrapper {
            border-radius: 20px;
            overflow: hidden;
            border: 1px solid rgba(31, 41, 55, 1);
            background: #020617;
            box-shadow:
                0 18px 45px rgba(15, 23, 42, 1),
                0 0 0 1px rgba(15, 23, 42, 1);
        }

        #map {
            width: 100%;
            height: 480px;
        }

        .map-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            background: linear-gradient(to right, rgba(15, 23, 42, 1), rgba(15, 23, 42, 0.96));
            border-bottom: 1px solid rgba(31, 41, 55, 1);
        }

        .map-filter-group {
            display: flex;
            gap: 6px;
        }

        .filter-btn {
            border-radius: 999px;
            border: 1px solid rgba(55, 65, 81, 0.9);
            background: rgba(15, 23, 42, 0.98);
            color: var(--color-text-soft);
            font-size: 11px;
            padding: 4px 10px;
            cursor: pointer;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #38bdf8, #22c55e);
            color: #0f172a;
            border-color: transparent;
            box-shadow:
                0 10px 20px rgba(15, 23, 42, 1),
                0 0 0 1px rgba(15, 23, 42, 1);
        }

        .map-legend {
            display: flex;
            gap: 10px;
            font-size: 11px;
            color: var(--color-text-soft);
        }

        .legend-item {
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
        }

        .status-badge {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 999px;
            border: 1px solid rgba(55, 65, 81, 1);
            background: rgba(15, 23, 42, 1);
        }

        .status-badge.on-shift {
            background: #dcfce7;
            color: #166534;
            border-color: rgba(22, 101, 52, 0.4);
        }

        .status-pill {
            font-size: 11px;
            padding: 3px 9px;
            border-radius: 999px;
            border: 1px solid rgba(55, 65, 81, 1);
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(15, 23, 42, 1);
            color: var(--color-text-soft);
        }

        .status-dot-free {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: #22c55e;
        }

        .status-dot-busy {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: #f97373;
        }

        .status-dot-offline {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: #6b7280;
        }

        .nfo-panel {
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: rgba(15, 23, 42, 0.98);
            border-radius: 20px;
            border: 1px solid rgba(31, 41, 55, 1);
            padding: 10px;
        }

        .nfo-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nfo-panel-title {
            font-size: 13px;
            font-weight: 600;
        }

        .nfo-panel-subtitle {
            font-size: 11px;
            color: var(--color-text-soft);
        }

        .nfo-search {
            border-radius: 999px;
            border: 1px solid rgba(55, 65, 81, 1);
            background: rgba(15, 23, 42, 1);
            padding: 6px 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nfo-search input {
            flex: 1;
            border: none;
            outline: none;
            background: transparent;
            color: var(--color-text);
            font-size: 12px;
        }

        .nfo-list {
            max-height: 360px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .nfo-card {
            border-radius: 16px;
            border: 1px solid rgba(31, 41, 55, 1);
            padding: 9px 10px;
            background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 1));
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 8px;
        }

        .nfo-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nfo-card-title {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nfo-card-title span.name {
            font-size: 13px;
            font-weight: 500;
        }

        .nfo-card-subtitle {
            font-size: 11px;
            color: var(--color-text-soft);
        }

        .nfo-card-badges {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .nfo-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: var(--color-text-soft);
        }

        .chip {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 999px;
            border: 1px solid rgba(55, 65, 81, 1);
            background: rgba(15, 23, 42, 1);
        }

        .chip.busy {
            border-color: rgba(248, 113, 113, 0.7);
            color: #fecaca;
        }

        .chip.free {
            border-color: rgba(74, 222, 128, 0.7);
            color: #bbf7d0;
        }

        .chip.on-shift {
            border-color: rgba(56, 189, 248, 0.7);
            color: #bae6fd;
        }

        .chip-offline {
            border-color: rgba(75, 85, 99, 1);
            color: #9ca3af;
        }

        .chip-online {
            border-color: rgba(74, 222, 128, 0.8);
            color: #bbf7d0;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 999px;
        }

        .status-indicator.free {
            background: #22c55e;
        }

        .status-indicator.busy {
            background: #f97373;
        }

        .status-indicator.offline {
            background: #6b7280;
        }

        .scroll-area {
            max-height: 420px;
            overflow-y: auto;
            padding-right: 6px;
        }

        .pill {
            border-radius: 999px;
            padding: 3px 8px;
            font-size: 11px;
            border: 1px solid rgba(55, 65, 81, 1);
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .pill-label {
            font-size: 11px;
            color: var(--color-text-soft);
        }

        .login-select {
            width: 100%;
            border-radius: 999px;
            border: 1px solid rgba(55, 65, 81, 1);
            padding: 7px 10px;
            background: rgba(15, 23, 42, 1);
            color: var(--color-text);
            font-size: 12px;
        }

        .tile-grid {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 8px;
        }

        .tile {
            border-radius: 14px;
            padding: 6px 8px;
            background: radial-gradient(circle at top left, rgba(15, 23, 42, 1), rgba(15, 23, 42, 1));
            border: 1px solid rgba(31, 41, 55, 1);
            font-size: 11px;
        }

        .tile-label {
            color: var(--color-text-soft);
            margin-bottom: 2px;
        }

        .tile-value {
            font-size: 14px;
            font-weight: 600;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 8px;
            align-items: flex-end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 11px;
        }

        .form-group label {
            color: var(--color-text-soft);
        }

        .form-group input,
        .form-group select {
            border-radius: 999px;
            border: 1px solid rgba(55, 65, 81, 1);
            padding: 6px 9px;
            background: rgba(15, 23, 42, 1);
            color: var(--color-text);
            font-size: 12px;
        }

        .btn-secondary {
            border-radius: 999px;
            border: 1px solid rgba(55, 65, 81, 1);
            background: rgba(15, 23, 42, 1);
            color: var(--color-text-soft);
            padding: 6px 10px;
            font-size: 11px;
            cursor: pointer;
        }

        .btn-secondary:hover {
            border-color: rgba(148, 163, 184, 1);
        }

        .badge {
            border-radius: 999px;
            padding: 2px 8px;
            font-size: 11px;
            border: 1px solid rgba(55, 65, 81, 1);
            background: rgba(15, 23, 42, 1);
            color: var(--color-text-soft);
        }

        .text-danger {
            color: #fecaca;
        }

        .text-soft {
            color: var(--color-text-soft);
        }

        .tab-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .tab {
            border-radius: 999px;
            border: 1px solid rgba(55, 65, 81, 1);
            padding: 4px 10px;
            font-size: 11px;
            background: rgba(15, 23, 42, 1);
            color: var(--color-text-soft);
            cursor: pointer;
        }

        .tab.active {
            background: linear-gradient(135deg, #38bdf8, #22c55e);
            color: #0f172a;
            border-color: transparent;
            box-shadow:
                0 10px 20px rgba(15, 23, 42, 1),
                0 0 0 1px rgba(15, 23, 42, 1);
        }

        @media (max-width: 1024px) {
            .app-main {
                grid-template-columns: minmax(0, 1fr);
            }

            .layout-main {
                grid-template-columns: minmax(0, 1fr);
            }

            #map {
                height: 360px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 12px;
            }

            .app-header {
                flex-direction: column;
            }

            .login-card {
                width: 100%;
            }

            .kpi-row {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .tile-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }
    </style>
</head>
<body>
<div class="app-shell">
    <header class="app-header">
        <section class="brand-card">
            <div class="brand-card-inner">
                <div class="brand-avatar">
                    <div class="brand-avatar-inner">
                        <div class="brand-avatar-icon"></div>
                    </div>
                </div>
                <div class="brand-text">
                    <div class="brand-title">
                        NFO Ops Compass
                        <span class="brand-title-badge">LIVE FIELD VISIBILITY</span>
                    </div>
                    <div class="brand-subtitle">
                        Unified view for NFOs and Operations ‚Äì live login status, busy/free allocation, and nearest-site routing in Western Region.
                    </div>
                    <div class="brand-meta-row">
                        <div class="brand-meta-pill">
                            <span class="brand-meta-dot"></span>
                            <span>Mobily Western Region ‚Äì Jeddah ¬∑ Makkah ¬∑ Taif ¬∑ Remote</span>
                        </div>
                        <div class="brand-meta-pill">
                            <span class="brand-meta-dot"></span>
                            <span>Real-time NFO availability ¬∑ GPS-based dispatch</span>
                        </div>
                    </div>
                </div>
                <div class="brand-right">
                    <div class="brand-tagline">Field Readiness</div>
                    <div class="brand-version">Build v1.7 ‚Äì Supabase + Leaflet</div>
                    <div class="brand-pulse">
                        <div class="brand-pulse-dot"></div>
                    </div>
                </div>
            </div>
        </section>

        <section class="login-card">
            <div class="login-card-header">
                <div>
                    <div class="login-title">Unified Login Panel</div>
                    <div style="font-size: 11px; color: var(--color-text-soft);">
                        Choose your role and authenticate using your NFO credentials.
                    </div>
                </div>
                <div class="login-mode-toggle">
                    <button id="modeNfo" class="active" type="button">NFO View</button>
                    <button id="modeMgmt" type="button">Management View</button>
                </div>
            </div>

            <div class="login-card-body">
                <div class="login-input-group">
                    <label for="loginUserSelect">Select User</label>
                    <select id="loginUserSelect" class="login-select">
                        <option value="">Loading users‚Ä¶</option>
                    </select>
                </div>
                <div class="login-input-group">
                    <label for="loginPasswordInput">Password</label>
                    <input id="loginPasswordInput" type="password" placeholder="Enter password">
                </div>
            </div>

            <div class="login-card-footer">
                <div class="login-status-pill">
                    <span class="login-status-dot"></span>
                    <span id="loginStatusText">Awaiting login</span>
                </div>
                <button id="loginButton" class="btn btn-primary" type="button">
                    <span id="loginButtonLabel">Log in</span>
                </button>
            </div>
        </section>
    </header>

    <main class="app-main">
        <section class="panel">
            <header class="panel-header">
                <div class="panel-title-group">
                    <div class="panel-title">Fleet Status Overview</div>
                    <div class="panel-subtitle">
                        Live counts for NFO availability and mapped sites.
                    </div>
                </div>
                <div>
                    <span class="badge" id="currentModeLabel">NFO Mode</span>
                </div>
            </header>

            <section class="kpi-row">
                <article class="kpi-card">
                    <div class="kpi-label">Total NFOs</div>
                    <div class="kpi-value" id="totalNFOs">0</div>
                    <div class="kpi-footer">
                        Logged in: <span id="totalOnlineNFOs">0</span>
                    </div>
                </article>
                <article class="kpi-card">
                    <div class="kpi-label">Busy NFOs</div>
                    <div class="kpi-value text-danger" id="totalBusyNFOs">0</div>
                    <div class="kpi-footer">
                        Free NFOs: <span id="totalFreeNFOs">0</span>
                    </div>
                </article>
                <article class="kpi-card">
                    <div class="kpi-label">Sites Loaded</div>
                    <div class="kpi-value" id="totalSites">0</div>
                    <div class="kpi-footer">
                        With coordinates: <span id="totalSitesWithCoords">0</span>
                    </div>
                </article>
                <article class="kpi-card">
                    <div class="kpi-label">Map Filters</div>
                    <div class="kpi-footer">
                        <span class="status-dot-free"></span> Free
                        <span class="status-dot-busy" style="margin-left: 6px;"></span> Busy
                        <span class="status-dot-offline" style="margin-left: 6px;"></span> Offline
                    </div>
                </article>
            </section>

            <section class="layout-main">
                <section class="map-wrapper">
                    <div class="map-toolbar">
                        <div class="map-filter-group">
                            <button class="filter-btn active" data-map-filter="all">All NFOs</button>
                            <button class="filter-btn" data-map-filter="busy">Busy</button>
                            <button class="filter-btn" data-map-filter="free">Free</button>
                            <button class="filter-btn" data-map-filter="sites">Sites Only</button>
                        </div>
                        <div class="map-legend">
                            <div class="legend-item">
                                <span class="legend-dot" style="background:#22c55e;"></span> Free
                            </div>
                            <div class="legend-item">
                                <span class="legend-dot" style="background:#f97373;"></span> Busy
                            </div>
                            <div class="legend-item">
                                <span class="legend-dot" style="background:#fbbf24;"></span> Sites
                            </div>
                        </div>
                    </div>
                    <div id="map"></div>
                </section>

                <section class="nfo-panel">
                    <header class="nfo-panel-header">
                        <div>
                            <div class="nfo-panel-title">Field Engineers</div>
                            <div class="nfo-panel-subtitle">
                                View live status, nearest sites and routes.
                            </div>
                        </div>
                        <div style="display:flex; gap: 8px; align-items: center;">
                            <label for="loginFilter" class="pill-label">Login filter:</label>
                            <select id="loginFilter" class="login-select" style="width:auto; padding:4px 8px; font-size:11px;">
                                <option value="all">All</option>
                                <option value="logged-in">Logged in</option>
                                <option value="logged-out">Logged out</option>
                            </select>
                        </div>
                    </header>

                    <section class="nfo-search">
                        <span style="font-size:14px; color:var(--color-text-soft);">üîç</span>
                        <input id="nfoSearchInput" type="text" placeholder="Search NFO by name or ID‚Ä¶">
                        <button id="nfoSearchClear" class="btn-ghost" type="button" style="font-size:11px; padding:3px 6px;">
                            Clear
                        </button>
                    </section>
                    <div id="nfoSearchResults" class="scroll-area"></div>
                    <hr style="border: none; border-top: 1px solid rgba(31,41,55,1); margin: 6px 0;">
                    <div class="nfo-list">
                        <h3>Field Engineers Status</h3>
                        <div style="display: flex; align-items: center; gap: 8px; margin: 8px 0 12px 0;">
                            <label for="regionFilter" style="font-size: 12px; color: var(--color-text-secondary);">Filter by Location:</label>
                            <select id="regionFilter" style="padding: 6px 10px; border: 1px solid var(--color-border); border-radius: 8px; font-size: 12px;">
                                <option value="all">All Locations</option>
                            </select>
                        </div>
                        <div class="tab-bar" style="display: flex; gap: 8px; margin-bottom: 10px;">
                            <button class="filter-btn login-tab active" data-login-filter="all">All NFOs</button>
                            <button class="filter-btn login-tab" data-login-filter="logged-in">Logged in NFOs</button>
                            <button class="filter-btn login-tab" data-login-filter="logged-out">Logged out NFOs</button>
                        </div>
                        <div id="nfoListContainer"></div>
                    </div>
                </section>
            </section>
        </section>

        <section class="panel" id="nfoActionsPanel">
            <header class="panel-header">
                <div class="panel-title-group">
                    <div class="panel-title">My NFO Console</div>
                    <div class="panel-subtitle">
                        Update your shift status, activity and GPS location.
                    </div>
                </div>
                <div class="badge" id="currentNfoLabel">Not logged in</div>
            </header>

            <section class="tile-grid">
                <article class="tile">
                    <div class="tile-label">Current Status</div>
                    <div class="tile-value" id="myStatusLabel">Unknown</div>
                    <div class="tile-label" id="myOnShiftLabel">On shift: No</div>
                </article>
                <article class="tile">
                    <div class="tile-label">Assigned Site</div>
                    <div class="tile-value" id="mySiteLabel">None</div>
                    <div class="tile-label" id="mySiteAreaLabel">Area: N/A</div>
                </article>
                <article class="tile">
                    <div class="tile-label">Last Ping</div>
                    <div class="tile-value" id="myLastPingLabel">Never</div>
                    <div class="tile-label" id="myPingStatusLabel">Offline</div>
                </article>
                <article class="tile">
                    <div class="tile-label">GPS Lock</div>
                    <div class="tile-value" id="myGpsLabel">Unknown</div>
                    <div class="tile-label" id="myGpsDetailLabel">No coordinates</div>
                </article>
            </section>

            <section class="form-row">
                <div class="form-group">
                    <label for="activityInput">Activity / Work Order</label>
                    <input id="activityInput" placeholder="e.g. PMR @ W2852 ‚Äì WO123456">
                </div>
                <div class="form-group">
                    <label for="siteIdInput">Site ID (optional)</label>
                    <input id="siteIdInput" placeholder="W2852">
                </div>
                <div class="form-group">
                    <button id="updateStatusBtn" class="btn btn-primary" type="button">
                        Update Busy / Free
                    </button>
                </div>
            </section>

            <section class="form-row">
                <div class="form-group">
                    <label>Shift Control</label>
                    <div style="display:flex; gap: 8px;">
                        <button id="startShiftBtn" class="btn-secondary" type="button">Start Shift</button>
                        <button id="endShiftBtn" class="btn-secondary" type="button">End Shift</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>GPS / Location</label>
                    <div style="display:flex; gap: 8px;">
                        <button id="enableGpsBtn" class="btn-secondary" type="button">Enable GPS</button>
                        <button id="disableGpsBtn" class="btn-secondary" type="button">Disable GPS</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Session</label>
                    <div style="display:flex; gap: 8px;">
                        <button id="logoutBtn" class="btn-secondary" type="button">Log out</button>
                    </div>
                </div>
            </section>

            <section>
                <div class="form-group">
                    <label>Search nearest NFO for a site (Management View)</label>
                    <div style="display:flex; gap:4px; align-items:center; margin-bottom:6px;">
                        <select id="searchMode" class="login-select" style="width:auto; padding:4px 8px; font-size:11px;">
                            <option value="site">Search by Site ID</option>
                            <option value="nearest">Nearest available NFO</option>
                        </select>
                        <select id="searchNfoStatus" class="login-select" style="width:auto; padding:4px 8px; font-size:11px;">
                            <option value="free">Free</option>
                            <option value="busy">Busy</option>
                            <option value="any">Any (on shift)</option>
                        </select>
                    </div>
                    <div style="display:flex; gap:8px;">
                        <input id="searchInput" placeholder="Site ID (e.g. W2852)" style="flex:1; border-radius:999px; border:1px solid rgba(55,65,81,1); padding:6px 9px; background:rgba(15,23,42,1); color:var(--color-text); font-size:12px;">
                        <button id="searchBtn" class="btn-secondary" type="button">Search</button>
                    </div>
                    <div id="searchResult" style="margin-top:6px; font-size:12px; color:var(--color-text-soft);"></div>
                </div>
            </section>
        </section>
    </main>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.48.0/dist/umd/supabase.min.js"></script>
<script>
    const SUPABASE_URL = 'https://wovyyssztpileuloxxnp.supabase.co';
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY_HERE';
    const SUPABASE_NFO_STATUS_TABLE = 'nfo_status';

    const NFO_REFRESH_INTERVAL_MS = 15000;

    const AREA_COLORS = {
        'jeddah': '#38bdf8',
        'makkah': '#f97373',
        'taif': '#a855f7',
        'baha': '#22c55e',
        'remote': '#facc15'
    };

    const DEFAULT_COORDINATES = {
        lat: 21.543333,
        lng: 39.172778
    };

    let supabaseClient = null;
    if (window.supabase && SUPABASE_URL && SUPABASE_ANON_KEY) {
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }

    let nfoData = [];
    let siteData = [];

    let currentUser = null;
    let map = null;
    let nfoMarkers = [];
    let siteMarkers = [];
    let nfoRouteLayers = new Map();
    let nfoConnectionLines = [];
    let dispatchLines = [];
    let selectedNfoId = null;
    let watchId = null;
    let currentMapFilter = 'all';
    let currentLoginFilter = 'all';
    let currentRegionFilter = 'all';

    let nfoUsers = [];
    let mgmtUsers = [];

    const DEFAULT_NFO_USERS = [
        { username: 'ZOGDSMR', password: 'ZOGDSMR', fullName: 'Muhammad Yasir' },
        { username: 'ZAMEBIR', password: 'ZAMEBIR', fullName: 'Mir Muhammad Abeer' }
    ];

    const DEFAULT_MGMT_USERS = [
        { username: 'MGMT1', password: 'MGMT1', fullName: 'Duty Manager ‚Äì Jeddah' }
    ];

    function parseCSV(text, { skipHeader = false } = {}) {
        if (!text || typeof text !== 'string') return [];
        const lines = text.split(/\r?\n/).filter(line => line.trim().length > 0);
        if (!lines.length) return [];

        const rows = lines.map(line => {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result.map(cell => cell.trim());
        });

        return skipHeader ? rows.slice(1) : rows;
    }

    function dedupeUsers(users) {
        const byUsername = new Map();

        users.forEach(user => {
            const key = (user.username || '').toLowerCase();
            if (!key) return;

            const existing = byUsername.get(key);
            if (!existing) {
                byUsername.set(key, { ...user });
                return;
            }

            if (!existing.fullName && user.fullName) {
                existing.fullName = user.fullName;
            }
            if (!existing.location && user.location) {
                existing.location = user.location;
            }
        });

        return Array.from(byUsername.values());
    }

    function hasValidLocation(location) {
        if (!location || typeof location !== 'object') return false;
        const { lat, lng } = location;
        const latNum = typeof lat === 'string' ? parseFloat(lat) : lat;
        const lngNum = typeof lng === 'string' ? parseFloat(lng) : lng;
        return Number.isFinite(latNum) && Number.isFinite(lngNum);
    }

    function loadUsersFromText(text, fallback) {
        const rows = parseCSV(text, { skipHeader: true });
        const users = rows
            .filter(row => row.length >= 2 && row[0] && row[1])
            .map(row => {
                const username = row[0];
                const password = row[1];
                const fullName = row[2] || row[0];
                const location = row[3] || '';
                return {
                    username,
                    password,
                    fullName,
                    location
                };
            });

        const result = users.length ? users : fallback;
        return dedupeUsers(result);
    }

    function loadSitesFromText(text) {
        const rows = parseCSV(text, { skipHeader: true });
        return rows
            .filter(row => row.length >= 3 && row[0])
            .map(row => {
                const id = row[0];
                const lat = parseFloat(row[1]);
                const lng = parseFloat(row[2]);
                const area = (row[3] || '').toLowerCase();
                const name = row[4] || '';
                const hasCoords = Number.isFinite(lat) && Number.isFinite(lng);
                return {
                    id,
                    name,
                    area,
                    location: hasCoords ? { lat, lng } : { ...DEFAULT_COORDINATES },
                    hasCoords,
                    isDefaultLocation: !hasCoords,
                    missingCoords: !hasCoords
                };
            });
    }

    function loadPersistedNFOState() {
        try {
            const cached = localStorage.getItem('nfoState_v1');
            if (!cached) return null;
            const parsed = JSON.parse(cached);
            if (!Array.isArray(parsed)) return null;
            return parsed;
        } catch (err) {
            console.warn('Failed to parse persisted NFO state:', err);
            return null;
        }
    }

    function persistNFOState() {
        try {
            const serializable = nfoData.map(nfo => {
                const { id, name, onShift, status, activity, siteId, workOrderId, location, routeInfo, loggedIn, lastPing, lastPingMs } = nfo;
                return { id, name, onShift, status, activity, siteId, workOrderId, location, routeInfo, loggedIn, lastPing, lastPingMs };
            });
            localStorage.setItem('nfoState_v1', JSON.stringify(serializable));
        } catch (err) {
            console.warn('Failed to persist NFO state:', err);
        }
    }

    function getCurrentNfo() {
        if (!currentUser || !currentUser.id) {
            alert('NFO profile not found. Please log in again.');
            return null;
        }

        const nfo = nfoData.find(n => n.id === currentUser.id);
        if (!nfo) {
            alert('NFO record not found in data. Please contact admin.');
            return null;
        }
        return nfo;
    }

    function refreshCurrentNfoPanel() {
        const nfo = getCurrentNfo();
        const labelEl = document.getElementById('currentNfoLabel');
        const statusEl = document.getElementById('myStatusLabel');
        const onShiftEl = document.getElementById('myOnShiftLabel');
        const siteLabelEl = document.getElementById('mySiteLabel');
        const siteAreaLabelEl = document.getElementById('mySiteAreaLabel');
        const lastPingLabelEl = document.getElementById('myLastPingLabel');
        const pingStatusLabelEl = document.getElementById('myPingStatusLabel');
        const gpsLabelEl = document.getElementById('myGpsLabel');
        const gpsDetailLabelEl = document.getElementById('myGpsDetailLabel');

        if (!nfo || !labelEl) return;

        labelEl.textContent = `${nfo.name || nfo.id} (${nfo.id})`;
        statusEl.textContent = nfo.status === 'busy'
            ? (nfo.activity ? `Busy ‚Äì ${nfo.activity}` : 'Busy')
            : 'Free';
        onShiftEl.textContent = `On shift: ${nfo.onShift ? 'Yes' : 'No'}`;

        if (nfo.siteId) {
            const site = getSiteById(nfo.siteId);
            siteLabelEl.textContent = site
                ? `${site.id}${site.name ? ' | ' + site.name : ''}`
                : nfo.siteId;
            siteAreaLabelEl.textContent = site && site.area
                ? `Area: ${site.area.toUpperCase()}`
                : 'Area: N/A';
        } else {
            siteLabelEl.textContent = 'None';
            siteAreaLabelEl.textContent = 'Area: N/A';
        }

        if (nfo.lastPingMs) {
            const deltaSec = Math.floor((Date.now() - nfo.lastPingMs) / 1000);
            const min = Math.floor(deltaSec / 60);
            const sec = deltaSec % 60;
            const lastPingDisplay = deltaSec < 60
                ? `${deltaSec}s ago`
                : `${min}m ${sec}s ago`;
            lastPingLabelEl.textContent = lastPingDisplay;
        } else {
            lastPingLabelEl.textContent = 'Never';
        }

        pingStatusLabelEl.textContent = nfo.isOnline
            ? 'Online (ping < 1 min)'
            : 'Offline / no ping';

        if (hasValidLocation(nfo.location)) {
            gpsLabelEl.textContent = 'OK';
            gpsDetailLabelEl.textContent = `Lat: ${nfo.location.lat.toFixed(5)}, Lng: ${nfo.location.lng.toFixed(5)}`;
        } else {
            gpsLabelEl.textContent = 'Unknown';
            gpsDetailLabelEl.textContent = 'No coordinates';
        }
    }

    function updateStats() {
        const total = nfoData.length;
        const busyCount = nfoData.filter(n => n.status === 'busy' && n.onShift).length;
        const freeCount = nfoData.filter(n => n.status === 'free' && n.onShift).length;
        const onlineCount = nfoData.filter(n => n.isOnline).length;

        document.getElementById('totalNFOs').textContent = total;
        document.getElementById('totalBusyNFOs').textContent = busyCount;
        document.getElementById('totalFreeNFOs').textContent = freeCount;
        document.getElementById('totalOnlineNFOs').textContent = onlineCount;

        const sitesWithCoords = siteData.filter(s => s.hasCoords).length;
        document.getElementById('totalSitesWithCoords').textContent = sitesWithCoords;
    }

    function getSiteById(id) {
        if (!id) return null;
        const normalized = String(id).trim().toUpperCase();
        return siteData.find(site => String(site.id).trim().toUpperCase() === normalized) || null;
    }

    function getAreaColor(area) {
        if (!area) return '#fbbf24';
        const key = area.toLowerCase();
        return AREA_COLORS[key] || '#fbbf24';
    }

    function fetchCSV(fileName) {
        return fetch(fileName)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Failed to load ${fileName}: ${response.statusText}`);
                }
                return response.text();
            })
            .catch(error => {
                console.error(`Error fetching ${fileName}:`, error);
                return '';
            });
    }

    function buildNfoCard(nfo) {
        let nearestLabel = 'Nearest site: N/A (no GPS or site coordinates)';
        let distanceLabel = 'Nearest site: N/A (no GPS or missing coordinates)';
        let freeLabel = '';
        let routeLabel = '';
        const isOnline = !!nfo.isOnline;
        const loginLabel = isOnline
            ? 'Online (ping < 1 min)'
            : 'Offline / no ping';
        const loginBadge = `<span style="margin-left: 8px; padding:2px 8px; border-radius:999px; font-size:11px; border:1px solid rgba(75,85,99,0.9); background:rgba(15,23,42,1); color:${isOnline ? '#bbf7d0' : '#9ca3af'};">${loginLabel}</span>`;

        if (nfo.status === 'busy' && nfo.siteId) {
            const targetSite = getSiteById(nfo.siteId);
            if (targetSite) {
                nearestLabel = `Active site: ${targetSite.id}${targetSite.name ? ' | ' + targetSite.name : ''}`;
            }

            if (hasValidLocation(nfo.location) && targetSite && hasValidLocation(targetSite.location)) {
                if (targetSite.isDefaultLocation || targetSite.missingCoords) {
                    distanceLabel = 'Active site distance: N/A (default/missing coords)';
                } else {
                    const distanceKm = haversineDistance(nfo.location, targetSite.location);
                    distanceLabel = `Active site distance: ${distanceKm.toFixed(1)} km`;
                }
            } else {
                distanceLabel = 'Active site distance: N/A (no GPS or missing coords)';
            }

            freeLabel = 'Mark Free: Use activity panel below map.';
        } else {
            if (hasValidLocation(nfo.location)) {
                const nearest = findNearestSite(nfo.location);
                if (nearest) {
                    nearestLabel = `Nearest site: ${nearest.site.id}${nearest.site.name ? ' | ' + nearest.site.name : ''}`;
                    if (nearest.site.isDefaultLocation || nearest.site.missingCoords) {
                        distanceLabel = 'Nearest site distance: N/A (default/missing coords)';
                    } else {
                        distanceLabel = `Nearest site distance: ${nearest.distance.toFixed(1)} km`;
                    }
                } else {
                    nearestLabel = 'Nearest site: N/A (no site coordinates available)';
                    distanceLabel = 'Nearest site distance: N/A (no site coordinates available)';
                }
            } else {
                nearestLabel = 'Nearest site: N/A (no GPS or site coordinates)';
                distanceLabel = 'Nearest site distance: N/A (no GPS or site coordinates)';
            }

            freeLabel = 'Status: Free';
        }

        if (nfo.status === 'busy' && nfo.siteId) {
            routeLabel = nfo.routeInfo
                ? `ETA: ${nfo.routeInfo.durationText || 'N/A'} | Distance: ${nfo.routeInfo.distanceText || 'N/A'}`
                : 'ETA: Not calculated yet.';
        } else {
            routeLabel = 'ETA: Not applicable (NFO is free).';
        }

        const isOnShift = !!nfo.onShift;
        const busyChip = nfo.status === 'busy'
            ? '<span class="chip busy">üî¥ Busy</span>'
            : '<span class="chip free">üü¢ Free</span>';
        const shiftChip = isOnShift
            ? '<span class="chip on-shift">On Shift</span>'
            : '<span class="chip">Off Shift</span>';
        const onlineChip = isOnline
            ? '<span class="chip chip-online">üü¢ Online</span>'
            : '<span class="chip chip-offline">‚ö™ Offline</span>';
        const activityLabel = nfo.activity
            ? `Activity: ${nfo.activity}`
            : 'Activity: None';

        const detailLines = [
            nearestLabel,
            distanceLabel,
            activityLabel,
            routeLabel
        ].join('<br>');

        const etaButton = (nfo.status === 'busy' && nfo.siteId && hasValidLocation(nfo.location))
            ? `<button class="btn-secondary btn-eta" data-nfo-id="${nfo.id}" data-site-id="${nfo.siteId}" style="margin-top:4px;">Recalculate ETA</button>`
            : '';

        const hideRouteButton = nfo.routeInfo
            ? `<button class="btn-secondary btn-hide-route" data-nfo-id="${nfo.id}" style="margin-top:4px; margin-left:4px;">Hide Route</button>`
            : '';

        return `
            <div class="nfo-card" data-nfo-id="${nfo.id}">
                <div class="nfo-card-header">
                    <div class="nfo-card-title">
                        <span class="status-indicator ${nfo.status}"></span>
                        ${nfo.name} (${nfo.id})${nfo.region ? ' - ' + nfo.region : ''} ${loginBadge}
                    </div>
                    <div class="nfo-card-badges">
                        ${busyChip}
                        ${shiftChip}
                        ${onlineChip}
                    </div>
                </div>
                <div class="nfo-card-subtitle">
                    <div style="font-size:12px; color:var(--color-text-soft);">
                        ${detailLines}
                        <div style="margin-top: 8px;">
                            ${etaButton}
                            ${hideRouteButton}
                        </div>
                    </div>
                </div>
                <span style="font-size: 12px; color: var(--color-text-secondary);">
                    ${nfo.status === 'busy' ? 'üî¥ Busy' : 'üü¢ Free'} | ${loginLabel}
                </span>
            </div>
        `;
    }

    function renderNfoCards(list, container, emptyMessage = 'No NFOs found', options = {}) {
        const { scrollToTop = false } = options;
        if (!container) return;

        if (!list || !list.length) {
            container.innerHTML = `<p style="color: var(--color-text-soft); font-size: 12px;">${emptyMessage}</p>`;
            return;
        }

        container.innerHTML = list.map(buildNfoCard).join('');

        if (scrollToTop) {
            container.scrollTo({ top: 0, behavior: 'smooth' });
        }

        wireRouteButtons(container);
    }

    function wireRouteButtons(container) {
        const etaButtons = container.querySelectorAll('.btn-eta');
        etaButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const nfoId = btn.getAttribute('data-nfo-id');
                const siteId = btn.getAttribute('data-site-id');
                if (!nfoId || !siteId) return;

                const nfo = nfoData.find(n => n.id === nfoId);
                const site = getSiteById(siteId);
                if (!nfo || !site) {
                    alert('NFO or site not found.');
                    return;
                }

                alert('ETA calculation placeholder ‚Äì integrate Directions API if needed.');
            });
        });

        const hideRouteButtons = container.querySelectorAll('.btn-hide-route');
        hideRouteButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const nfoId = btn.getAttribute('data-nfo-id');
                if (!nfoId) return;
                clearRouteForNfo(nfoId);
            });
        });
    }

    function haversineDistance(loc1, loc2) {
        const toRad = (value) => (value * Math.PI) / 180;
        const R = 6371;

        const lat1 = parseFloat(loc1.lat);
        const lng1 = parseFloat(loc1.lng);
        const lat2 = parseFloat(loc2.lat);
        const lng2 = parseFloat(loc2.lng);

        if (!Number.isFinite(lat1) || !Number.isFinite(lng1) || !Number.isFinite(lat2) || !Number.isFinite(lng2)) {
            return NaN;
        }

        const dLat = toRad(lat2 - lat1);
        const dLng = toRad(lng2 - lng1);
        const a =
            Math.sin(dLat / 2) ** 2 +
            Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
            Math.sin(dLng / 2) ** 2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    function findNearestSite(nfoLocation) {
        if (!hasValidLocation(nfoLocation)) return null;

        let bestSite = null;
        let bestDistance = Infinity;

        for (const site of siteData) {
            if (!hasValidLocation(site.location)) continue;
            const distance = haversineDistance(nfoLocation, site.location);
            if (!Number.isFinite(distance)) continue;

            if (distance < bestDistance) {
                bestDistance = distance;
                bestSite = site;
            }
        }

        if (!bestSite) return null;
        return {
            site: bestSite,
            distance: bestDistance
        };
    }

    function initMap() {
        if (map) return;

        map = L.map('map', {
            center: [DEFAULT_COORDINATES.lat, DEFAULT_COORDINATES.lng],
            zoom: 8,
            zoomControl: true
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            minZoom: 5,
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        refreshNfoMarkers();
        refreshSiteMarkers();
    }

    function clearNfoMarkers() {
        for (const marker of nfoMarkers) {
            map.removeLayer(marker);
        }
        nfoMarkers = [];
    }

    function clearSiteMarkers() {
        for (const marker of siteMarkers) {
            map.removeLayer(marker);
        }
        siteMarkers = [];
    }

    function refreshNfoMarkers() {
        if (!map) return;
        clearNfoMarkers();

        for (const nfo of nfoData) {
            if (!nfoPassesMapFilters(nfo)) continue;
            if (!hasValidLocation(nfo.location)) continue;

            const marker = L.circleMarker([nfo.location.lat, nfo.location.lng], {
                radius: 7,
                weight: 1,
                color: nfo.status === 'busy' ? '#f97373' : '#22c55e',
                fillColor: nfo.status === 'busy' ? '#fecaca' : '#bbf7d0',
                fillOpacity: 0.9
            });

            const onShift = nfo.onShift ? 'Yes' : 'No';
            const statusLabel = nfo.status === 'busy' ? 'Busy' : 'Free';

            marker.bindPopup(`
                <strong>${nfo.name || nfo.id}</strong><br>
                ID: ${nfo.id}<br>
                Region: ${nfo.region || 'N/A'}<br>
                Status: ${statusLabel}<br>
                On Shift: ${onShift}<br>
                Logged in: ${nfo.loggedIn ? 'Yes' : 'No'}<br>
                Online (ping < 1 min): ${nfo.isOnline ? 'Yes' : 'No'}
            `);

            marker.addTo(map);
            nfoMarkers.push(marker);
        }
    }

    function refreshSiteMarkers() {
        if (!map) return;
        clearSiteMarkers();

        if (currentMapFilter === 'sites' || currentMapFilter === 'all') {
            for (const site of siteData) {
                if (!hasValidLocation(site.location)) continue;

                const marker = L.circleMarker([site.location.lat, site.location.lng], {
                    radius: 5,
                    weight: 1,
                    color: getAreaColor(site.area),
                    fillColor: '#fbbf24',
                    fillOpacity: 0.9
                });

                marker.bindPopup(`
                    <strong>${site.id}</strong><br>
                    ${site.name ? site.name + '<br>' : ''}
                    Area: ${site.area ? site.area.toUpperCase() : 'N/A'}
                `);

                marker.addTo(map);
                siteMarkers.push(marker);
            }
        }
    }

    function clearRouteForNfo(nfoId) {
        const layerGroup = nfoRouteLayers.get(nfoId);
        if (layerGroup) {
            layerGroup.remove();
            nfoRouteLayers.delete(nfoId);
        }
    }

    function clearAllNfoRoutes() {
        for (const layerGroup of nfoRouteLayers.values()) {
            layerGroup.remove();
        }
        nfoRouteLayers.clear();
    }

    function centerMapOnNfo(nfoId) {
        const marker = nfoMarkers.find(m => m.options && m.options.nfoId === nfoId);
        if (marker) {
            map.setView(marker.getLatLng(), 12);
            marker.openPopup();
        }
    }

    function applyRouteForNfo(nfoId, fromLoc, toLoc, routeInfo) {
        if (!map || !hasValidLocation(fromLoc) || !hasValidLocation(toLoc)) return;

        clearRouteForNfo(nfoId);

        const polyline = L.polyline(
            [
                [fromLoc.lat, fromLoc.lng],
                [toLoc.lat, toLoc.lng]
            ],
            {
                color: '#fbbf24',
                weight: 3,
                opacity: 0.9,
                dashArray: '4,4'
            }
        ).addTo(map);

        const group = L.layerGroup([polyline]).addTo(map);
        nfoRouteLayers.set(nfoId, group);

        const bounds = L.latLngBounds(
            [fromLoc.lat, fromLoc.lng],
            [toLoc.lat, toLoc.lng]
        );
        map.fitBounds(bounds, { padding: [40, 40] });
    }

    function applyMapFilter() {
        refreshNfoMarkers();
        refreshSiteMarkers();
        updateStats();
    }

    function passesLoginFilter(nfo) {
        if (currentLoginFilter === 'logged-in') return !!nfo.isOnline;
        if (currentLoginFilter === 'logged-out') return !nfo.isOnline;
        return true;
    }

    function passesRegionFilter(nfo) {
        if (!currentRegionFilter || currentRegionFilter === 'all') return true;
        const region = (nfo.region || nfo.baseLocation || '').toString().trim().toLowerCase();
        return region === currentRegionFilter.toLowerCase();
    }

    function nfoPassesMapFilters(nfo) {
        if (!passesLoginFilter(nfo)) return false;
        if (!passesRegionFilter(nfo)) return false;

        switch(currentMapFilter) {
            case 'busy':
                return nfo.status === 'busy' && nfo.onShift;
            case 'free':
                return nfo.status === 'free' && nfo.onShift;
            case 'sites':
                return false;
            default:
                return true;
        }
    }

    function setLoginFilter(filter) {
        currentLoginFilter = filter;
        const loginFilterEl = document.getElementById('loginFilter');
        if (loginFilterEl) {
            loginFilterEl.value = filter;
        }
        document.querySelectorAll('.login-tab').forEach(btn => {
            const value = btn.getAttribute('data-login-filter');
            btn.classList.toggle('active', value === filter);
        });
        applyMapFilter();
        updateNFOList();
        renderNfoSearchResults();
    }

    function updateNFOList() {
        const container = document.getElementById('nfoListContainer');
        const filterStatus = currentMapFilter;
        const list = nfoData.filter(n => {
            if (!passesLoginFilter(n)) return false;
            if (!passesRegionFilter(n)) return false;
            if (filterStatus === 'busy' && n.status !== 'busy') return false;
            if (filterStatus === 'free' && n.status !== 'free') return false;
            return true;
        });

        renderNfoCards(list, container, 'No NFOs found');
    }

    function renderNfoSearchResults() {
        const input = document.getElementById('nfoSearchInput');
        const resultsEl = document.getElementById('nfoSearchResults');
        if (!input || !resultsEl) return;

        const query = input.value.trim().toLowerCase();
        if (!query) {
            resultsEl.innerHTML = '<p style="color: var(--color-text-secondary);">Type a name or ID to search.</p>';
            return;
        }

        const matches = nfoData.filter(nfo => {
            return (nfo.name && nfo.name.toLowerCase().includes(query)) ||
                (nfo.id && nfo.id.toLowerCase().includes(query));
        }).filter(nfo => passesLoginFilter(nfo) && passesRegionFilter(nfo));

        renderNfoCards(matches, resultsEl, 'No matching NFOs found', { scrollToTop: true });
    }

    function initNfoSearch() {
        const input = document.getElementById('nfoSearchInput');
        const clearBtn = document.getElementById('nfoSearchClear');
        const resultsEl = document.getElementById('nfoSearchResults');

        if (!input || !resultsEl) return;

        input.addEventListener('input', () => {
            renderNfoSearchResults();
        });

        if (clearBtn) {
            clearBtn.addEventListener('click', () => {
                input.value = '';
                renderNfoSearchResults();
            });
        }

        renderNfoSearchResults();
    }

    function initSearchPanel() {
        const modeSelect = document.getElementById('searchMode');
        const statusSelect = document.getElementById('searchNfoStatus');
        if (!modeSelect || !statusSelect) return;

        const toggleStatusVisibility = () => {
            statusSelect.style.display = modeSelect.value === 'nearest' ? 'block' : 'none';
        };

        modeSelect.addEventListener('change', () => {
            toggleStatusVisibility();
        });

        toggleStatusVisibility();

        const input = document.getElementById('searchInput');
        const button = document.getElementById('searchBtn');
        const resultEl = document.getElementById('searchResult');

        if (!input || !button || !resultEl) return;

        button.addEventListener('click', () => {
            const query = input.value.trim();
            const mode = modeSelect.value;
            const desiredStatus = statusSelect.value;

            if (!query) {
                resultEl.textContent = 'Please enter a site ID.';
                return;
            }

            const site = getSiteById(query);
            if (!site) {
                resultEl.textContent = `Site not found for ID ${query}.`;
                return;
            }

            if (!hasValidLocation(site.location)) {
                resultEl.textContent = `Site ${site.id} has no coordinates ‚Äì cannot compute distances.`;
                return;
            }

            if (mode === 'site') {
                const nfosForSite = nfoData.filter(n => n.siteId && String(n.siteId).trim().toUpperCase() === site.id.trim().toUpperCase());

                if (!nfosForSite.length) {
                    resultEl.textContent = `No NFO currently assigned to site ${site.id}.`;
                    return;
                }

                const busyCount = nfosForSite.filter(n => n.status === 'busy').length;
                const freeCount = nfosForSite.filter(n => n.status === 'free').length;
                resultEl.innerHTML = `
                    Site <strong>${site.id}</strong> has <strong>${nfosForSite.length}</strong> NFO(s) assigned.<br>
                    Busy: ${busyCount}, Free: ${freeCount}.
                `;
            } else if (mode === 'nearest') {
                const candidates = nfoData.filter(nfo => {
                    if (!hasValidLocation(nfo.location)) return false;
                    if (!nfo.onShift) return false;

                    if (desiredStatus === 'free' && nfo.status !== 'free') return false;
                    if (desiredStatus === 'busy' && nfo.status !== 'busy') return false;

                    return true;
                });

                if (!candidates.length) {
                    resultEl.textContent = `No NFO on shift with desired status (${desiredStatus}) and valid GPS to compute nearest.`;
                    return;
                }

                let bestNfo = null;
                let bestDistance = Infinity;

                for (const nfo of candidates) {
                    const d = haversineDistance(nfo.location, site.location);
                    if (!Number.isFinite(d)) continue;
                    if (d < bestDistance) {
                        bestDistance = d;
                        bestNfo = nfo;
                    }
                }

                if (!bestNfo) {
                    resultEl.textContent = 'Unable to compute nearest NFO ‚Äì check coordinates.';
                    return;
                }

                resultEl.innerHTML = `
                    Nearest NFO to site <strong>${site.id}</strong> (${site.name || 'no name'}) is
                    <strong>${bestNfo.name || bestNfo.id}</strong> [${bestNfo.id}] at
                    <strong>${bestDistance.toFixed(1)} km</strong> distance.
                `;
            }
        });
    }

    function initLoginTabs() {
        const tabs = document.querySelectorAll('.login-tab');
        if (!tabs.length) return;

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const filter = tab.dataset.loginFilter || 'all';
                currentLoginFilter = filter;
                setLoginFilter(filter);
            });
        });
    }

    function initRegionFilter() {
        const select = document.getElementById('regionFilter');
        if (!select) return;

        const regions = new Set();

        nfoUsers.forEach(user => {
            if (user.location) {
                regions.add(user.location.trim());
            }
        });
        nfoData.forEach(nfo => {
            if (nfo.region) {
                regions.add(String(nfo.region).trim());
            }
        });

        const sortedRegions = Array.from(regions).filter(Boolean).sort((a, b) => a.localeCompare(b));

        select.innerHTML = '<option value="all">All Locations</option>' +
            sortedRegions.map(r => `<option value="${r.toLowerCase()}">${r}</option>`).join('');

        select.value = currentRegionFilter || 'all';

        select.addEventListener('change', (event) => {
            const value = event.target.value || 'all';
            currentRegionFilter = value;
            updateNFOList();
            renderNfoSearchResults();
            applyMapFilter();
        });
    }

    function initManagementDashboard() {
        document.getElementById('totalNFOs').textContent = nfoData.length;
        document.getElementById('totalSites').textContent = siteData.length;

        initMap();
        initNfoSearch();
        initSearchPanel();
        const loginFilterEl = document.getElementById('loginFilter');
        if (loginFilterEl) {
            loginFilterEl.addEventListener('change', (event) => {
                setLoginFilter(event.target.value || 'all');
            });
        }
        initLoginTabs();
        initRegionFilter();
        renderNfoSearchResults();
        updateNFOList();
        updateStats();

        loadAllNfosFromSupabase();
        setInterval(loadAllNfosFromSupabase, NFO_REFRESH_INTERVAL_MS);
    }

    function initLoginPanel() {
        const modeNfoBtn = document.getElementById('modeNfo');
        const modeMgmtBtn = document.getElementById('modeMgmt');
        const loginUserSelect = document.getElementById('loginUserSelect');
        const loginPasswordInput = document.getElementById('loginPasswordInput');
        const loginButton = document.getElementById('loginButton');
        const loginStatusText = document.getElementById('loginStatusText');
        const loginButtonLabel = document.getElementById('loginButtonLabel');
        const currentModeLabel = document.getElementById('currentModeLabel');
        const nfoActionsPanel = document.getElementById('nfoActionsPanel');

        let currentMode = 'nfo';

        function updateModeUI() {
            if (currentMode === 'nfo') {
                modeNfoBtn.classList.add('active');
                modeMgmtBtn.classList.remove('active');
                currentModeLabel.textContent = 'NFO Mode';
                nfoActionsPanel.style.display = 'block';
            } else {
                modeNfoBtn.classList.remove('active');
                modeMgmtBtn.classList.add('active');
                currentModeLabel.textContent = 'Management Mode';
                nfoActionsPanel.style.display = 'none';
            }
        }

        modeNfoBtn.addEventListener('click', () => {
            currentMode = 'nfo';
            updateModeUI();
        });

        modeMgmtBtn.addEventListener('click', () => {
            currentMode = 'mgmt';
            updateModeUI();
        });

        function updateLoginStatus(message, isError = false) {
            loginStatusText.textContent = message;
            loginStatusText.style.color = isError ? '#fecaca' : '#9ca3af';
        }

        function getSelectedUser() {
            const value = loginUserSelect.value;
            if (!value) return null;
            const [role, username] = value.split(':');
            if (!username) return null;

            if (role === 'nfo') {
                return { role, user: nfoUsers.find(u => u.username === username) };
            }
            if (role === 'mgmt') {
                return { role, user: mgmtUsers.find(u => u.username === username) };
            }
            return null;
        }

        function login() {
            const selection = getSelectedUser();
            const password = loginPasswordInput.value;

            if (!selection || !selection.user) {
                updateLoginStatus('Please select a user.', true);
                return;
            }

            if (!password) {
                updateLoginStatus('Please enter a password.', true);
                return;
            }

            if (selection.user.password !== password) {
                updateLoginStatus('Invalid password.', true);
                return;
            }

            currentUser = {
                role: selection.role,
                id: selection.user.username,
                name: selection.user.fullName || selection.user.username
            };

            try {
                localStorage.setItem('nfoCurrentUser', JSON.stringify(currentUser));
            } catch (err) {
                console.warn('Failed to persist current user:', err);
            }

            updateLoginStatus(`Logged in as ${currentUser.name} (${currentUser.role.toUpperCase()})`);
            loginButtonLabel.textContent = 'Log out';

            if (currentUser.role === 'nfo') {
                const nfo = nfoData.find(n => n.id === currentUser.id);
                if (nfo) {
                    nfo.loggedIn = true;
                    markNfoPing(nfo);
                    refreshCurrentNfoPanel();
                    updateStats();
                    updateNFOList();
                    renderNfoSearchResults();
                    saveNfoStatusToSupabase(nfo);
                }
            }

            if (currentUser.role === 'mgmt') {
                initManagementDashboard();
            } else {
                if (map) {
                    map.remove();
                    map = null;
                    clearNfoMarkers();
                    clearSiteMarkers();
                    clearAllNfoRoutes();
                }
            }
        }

        function logout() {
            if (currentUser && currentUser.role === 'nfo') {
                const nfo = nfoData.find(n => n.id === currentUser.id);
                if (nfo) {
                    nfo.loggedIn = false;
                    nfo.isOnline = false;
                    saveNfoStatusToSupabase(nfo);
                }
            }

            currentUser = null;
            try {
                localStorage.removeItem('nfoCurrentUser');
            } catch (err) {
                console.warn('Failed to clear current user from storage:', err);
            }

            updateLoginStatus('Logged out.');
            loginButtonLabel.textContent = 'Log in';
        }

        loginButton.addEventListener('click', () => {
            if (!currentUser) {
                login();
            } else {
                logout();
            }
        });

        function populateUserSelects() {
            const options = [];

            nfoUsers.forEach(user => {
                options.push({
                    label: `NFO ‚Äì ${user.fullName || user.username}`,
                    value: `nfo:${user.username}`
                });
            });

            mgmtUsers.forEach(user => {
                options.push({
                    label: `Mgmt ‚Äì ${user.fullName || user.username}`,
                    value: `mgmt:${user.username}`
                });
            });

            if (!options.length) {
                loginUserSelect.innerHTML = '<option value="">No users loaded</option>';
                return;
            }

            loginUserSelect.innerHTML = [
                '<option value="">Select user‚Ä¶</option>',
                ...options.map(opt => `<option value="${opt.value}">${opt.label}</option>`)
            ].join('');
        }

        populateUserSelects();
        updateModeUI();

        try {
            const cachedUserStr = localStorage.getItem('nfoCurrentUser');
            if (cachedUserStr) {
                const cachedUser = JSON.parse(cachedUserStr);
                if (cachedUser && cachedUser.id && cachedUser.role) {
                    currentUser = cachedUser;
                    loginStatusText.textContent = `Session restored for ${currentUser.name} (${currentUser.role.toUpperCase()})`;
                    loginButtonLabel.textContent = 'Log out';

                    const matchOption = Array.from(loginUserSelect.options).find(
                        opt => opt.value === `${currentUser.role}:${currentUser.id}`
                    );
                    if (matchOption) {
                        loginUserSelect.value = matchOption.value;
                    }

                    if (currentUser.role === 'nfo') {
                        const nfo = nfoData.find(n => n.id === currentUser.id);
                        if (nfo) {
                            nfo.loggedIn = true;
                            markNfoPing(nfo);
                            refreshCurrentNfoPanel();
                            updateStats();
                            updateNFOList();
                            renderNfoSearchResults();
                            saveNfoStatusToSupabase(nfo);
                        }
                    }

                    if (currentUser.role === 'mgmt') {
                        initManagementDashboard();
                    }
                }
            }
        } catch (err) {
            console.warn('Failed to restore session from storage:', err);
        }
    }

    function markNfoPing(nfo) {
        const now = new Date();
        nfo.lastPing = now.toISOString();
        nfo.lastPingMs = now.getTime();
        nfo.isOnline = nfo.loggedIn && (Date.now() - nfo.lastPingMs <= 60000);
        refreshCurrentNfoPanel();
    }

    function initNfoActions() {
        const startShiftBtn = document.getElementById('startShiftBtn');
        const endShiftBtn = document.getElementById('endShiftBtn');
        const updateStatusBtn = document.getElementById('updateStatusBtn');
        const enableGpsBtn = document.getElementById('enableGpsBtn');
        const disableGpsBtn = document.getElementById('disableGpsBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const activityInput = document.getElementById('activityInput');
        const siteIdInput = document.getElementById('siteIdInput');

        startShiftBtn.addEventListener('click', () => {
            const nfo = getCurrentNfo();
            if (!nfo) return;
            nfo.onShift = true;
            markNfoPing(nfo);
            refreshCurrentNfoPanel();
            updateStats();
            updateNFOList();
            renderNfoSearchResults();
            saveNfoStatusToSupabase(nfo);
        });

        endShiftBtn.addEventListener('click', () => {
            const nfo = getCurrentNfo();
            if (!nfo) return;
            nfo.onShift = false;
            nfo.status = 'free';
            nfo.activity = null;
            nfo.siteId = null;
            nfo.workOrderId = null;
            nfo.routeInfo = null;
            markNfoPing(nfo);
            refreshCurrentNfoPanel();
            updateStats();
            updateNFOList();
            renderNfoSearchResults();
            saveNfoStatusToSupabase(nfo);
        });

        updateStatusBtn.addEventListener('click', () => {
            const nfo = getCurrentNfo();
            if (!nfo) return;

            const activity = activityInput.value.trim();
            const siteId = siteIdInput.value.trim();

            if (!activity) {
                nfo.status = 'free';
                nfo.activity = null;
                nfo.siteId = null;
                nfo.workOrderId = null;
                nfo.routeInfo = null;
            } else {
                nfo.status = 'busy';
                nfo.activity = activity;
                nfo.siteId = siteId || null;
            }

            markNfoPing(nfo);
            refreshCurrentNfoPanel();
            updateStats();
            updateNFOList();
            renderNfoSearchResults();
            saveNfoStatusToSupabase(nfo);
        });

        enableGpsBtn.addEventListener('click', () => {
            const nfo = getCurrentNfo();
            if (!nfo) return;

            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser.');
                return;
            }

            if (watchId != null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }

            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    nfo.location = { lat: latitude, lng: longitude };
                    markNfoPing(nfo);
                    refreshCurrentNfoPanel();
                    updateStats();
                    updateNFOList();
                    renderNfoSearchResults();
                    saveNfoStatusToSupabase(nfo);
                    refreshNfoMarkers();
                },
                (error) => {
                    console.error('Error watching position:', error);
                    alert('Unable to get GPS position.');
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 10000,
                    timeout: 20000
                }
            );
        });

        disableGpsBtn.addEventListener('click', () => {
            const nfo = getCurrentNfo();
            if (!nfo) return;

            if (watchId != null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }

            nfo.location = null;
            markNfoPing(nfo);
            refreshCurrentNfoPanel();
            updateStats();
            updateNFOList();
            renderNfoSearchResults();
            saveNfoStatusToSupabase(nfo);
            refreshNfoMarkers();
        });

        logoutBtn.addEventListener('click', () => {
            if (!currentUser) {
                alert('No active session.');
                return;
            }

            if (currentUser.role === 'nfo') {
                const nfo = nfoData.find(n => n.id === currentUser.id);
                if (nfo) {
                    nfo.loggedIn = false;
                    nfo.isOnline = false;
                    saveNfoStatusToSupabase(nfo);
                }
            }

            currentUser = null;
            try {
                localStorage.removeItem('nfoCurrentUser');
            } catch (err) {
                console.warn('Failed to clear current user from storage:', err);
            }

            const loginStatusText = document.getElementById('loginStatusText');
            const loginButtonLabel = document.getElementById('loginButtonLabel');
            loginStatusText.textContent = 'Logged out.';
            loginStatusText.style.color = '#9ca3af';
            loginButtonLabel.textContent = 'Log in';
        });
    }

    function getSupabaseClient() {
        if (!supabaseClient) {
            console.warn('Supabase client not configured.');
            return null;
        }
        return supabaseClient;
    }

    async function saveNfoStatusToSupabase(nfo) {
        const client = getSupabaseClient();
        if (!client) return;

        const payload = {
            id: nfo.id,
            on_shift: nfo.onShift,
            status: nfo.status,
            logged_in: !!nfo.loggedIn,
            last_ping: nfo.lastPing || null,
            activity: nfo.activity || null,
            site_id: nfo.siteId || null,
            work_order_id: nfo.workOrderId || null,
            lat: hasValidLocation(nfo.location) ? nfo.location.lat : null,
            lng: hasValidLocation(nfo.location) ? nfo.location.lng : null
        };

        try {
            const { error } = await client
                .from(SUPABASE_NFO_STATUS_TABLE)
                .upsert(payload, { onConflict: 'id' });

            if (error) {
                console.error('Error saving NFO status to Supabase:', error);
            }
        } catch (err) {
            console.error('Unexpected error saving NFO status to Supabase:', err);
        }
    }

    async function loadAllNfosFromSupabase() {
        const client = getSupabaseClient();
        if (!client || !nfoData.length) return;

        try {
            const { data, error } = await client
                .from(SUPABASE_NFO_STATUS_TABLE)
                .select('*');

            if (error) {
                console.error('Error loading NFO statuses from Supabase:', error);
                return;
            }

            if (!Array.isArray(data)) return;

            const previousById = new Map();
            for (const nfo of nfoData) {
                previousById.set(nfo.id, nfo);
            }

            const updatedMap = new Map();
            let changed = false;

            for (const row of data) {
                const id = row.id;
                if (!id) continue;

                const existing = updatedMap.get(id);
                const previous = previousById.get(id);

                const base = existing || previous || {
                    id,
                    name: id,
                    region: '',
                    onShift: false,
                    status: 'free',
                    activity: null,
                    siteId: null,
                    workOrderId: null,
                    location: { ...DEFAULT_COORDINATES },
                    routeInfo: null,
                    loggedIn: false,
                    lastPing: null,
                    lastPingMs: null,
                    isOnline: false
                };

                const lastPing = row.last_ping ? new Date(row.last_ping).toISOString() : null;
                const lastPingMs = lastPing ? new Date(lastPing).getTime() : null;
                const isOnline = !!(row.logged_in && lastPingMs && (Date.now() - lastPingMs <= 60000));

                const merged = {
                    ...base,
                    onShift: !!row.on_shift,
                    status: row.status || 'free',
                    activity: row.activity || null,
                    siteId: row.site_id || null,
                    workOrderId: row.work_order_id || null,
                    location: (row.lat != null && row.lng != null)
                        ? { lat: row.lat, lng: row.lng }
                        : base.location,
                    loggedIn: !!row.logged_in,
                    lastPing,
                    lastPingMs,
                    isOnline
                };

                updatedMap.set(id, merged);
            }

            nfoUsers.forEach(user => {
                const id = user.username;
                if (!updatedMap.has(id)) {
                    changed = true;
                    updatedMap.set(id, {
                        id,
                        name: user.fullName || id,
                        region: user.location || '',
                        onShift: false,
                        status: 'free',
                        activity: null,
                        siteId: null,
                        workOrderId: null,
                        location: { ...DEFAULT_COORDINATES },
                        routeInfo: null,
                        loggedIn: false,
                        lastPing: null,
                        lastPingMs: null,
                        isOnline: false
                    });
                }
            });

            const updatedNfoData = Array.from(updatedMap.values());
            if (updatedNfoData.length !== nfoData.length) {
                changed = true;
            } else {
                for (let i = 0; i < updatedNfoData.length; i++) {
                    const a = updatedNfoData[i];
                    const b = nfoData[i];
                    if (!b || a.id !== b.id) {
                        changed = true;
                        break;
                    }
                }
            }

            if (changed) {
                nfoData = updatedNfoData;
                persistNFOState();
                updateStats();
                updateNFOList();
                renderNfoSearchResults();
                refreshNfoMarkers();
                if (currentUser && currentUser.role === 'nfo') {
                    refreshCurrentNfoPanel();
                }
            }
        } catch (err) {
            console.error('Unexpected error loading NFO statuses from Supabase:', err);
        }
    }

    function initializeNFOData() {
        nfoData.length = 0;

        nfoUsers.forEach((user, index) => {
            nfoData.push({
                id: user.username,
                name: user.fullName || user.username || `Engineer ${index + 1}`,
                region: user.location || '',
                onShift: false,
                status: 'free',
                activity: null,
                siteId: null,
                workOrderId: null,
                location: null,
                routeInfo: null,
                loggedIn: false,
                lastPing: null,
                lastPingMs: null,
                isOnline: false
            });
        });

        document.getElementById('totalNFOs').textContent = nfoData.length;
    }

    async function loadDataFromFiles() {
        const [nfoText, mgmtText, siteText] = await Promise.all([
            fetchCSV('NFOusers.csv'),
            fetchCSV('MgmtUsers.csv'),
            fetchCSV('Site_Coordinates.csv')
        ]);

        nfoUsers = loadUsersFromText(nfoText, DEFAULT_NFO_USERS);
        mgmtUsers = loadUsersFromText(mgmtText, DEFAULT_MGMT_USERS);
        siteData = loadSitesFromText(siteText);

        initializeNFOData();

        document.getElementById('totalSites').textContent = siteData.length;
        document.getElementById('totalSitesWithCoords').textContent = siteData.filter(s => s.hasCoords).length;

        initLoginPanel();
        initNfoActions();

        const mapFilterButtons = document.querySelectorAll('.filter-btn[data-map-filter]');
        mapFilterButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const filter = btn.getAttribute('data-map-filter') || 'all';
                currentMapFilter = filter;

                mapFilterButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                applyMapFilter();
                updateNFOList();
                renderNfoSearchResults();
            });
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadDataFromFiles().then(() => {
            console.log('Data loaded, app initialized.');
        });
    });
</script>
</body>
</html>
